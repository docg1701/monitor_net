# Story 1.2: Core Monitoring Service Implementation

## Status
Done

## Story
**As a** Developer,
**I want** to implement the `MonitorService` using `HttpClient` and RxJS,
**so that** I can reliably measure network latency and manage application state without external dependencies.

## Acceptance Criteria
1.  `MonitorService` created as a singleton in `src/app/services/monitor.service.ts`.
2.  `PingResult` interface defined with strict typing.
3.  `measureLatency` function implements HTTP HEAD request logic using Angular `HttpClient`.
4.  State managed via `BehaviorSubject<PingResult[]>` (maintaining the last 50 results).
5.  Polling loop implemented with RxJS `timer` or `interval` with clean cancellation (`unsubscribe`).
6.  Error handling records "Packet Loss" correctly (latency `null` or error status).
7.  Unit tests implemented in `monitor.service.spec.ts` to verify latency calculation and error handling.

## Dev Notes
### Technology Stack
-   **Frontend Framework**: Angular v21+ (Standalone Components) [Source: `docs/rescrita-tecnica-angular.md#2-tech-stack-estabilidade-corporativa`]
-   **HTTP Client**: Angular `HttpClient` (Fetch/Axios are PROHIBITED) [Source: `docs/rescrita-tecnica-angular.md#23-bibliotecas-auxiliares-allowlist`]
-   **State Management**: RxJS `BehaviorSubject` (No Redux/NgRx) [Source: `docs/rescrita-tecnica-angular.md#42-serviço-de-monitoramento-monitorservicets`]

### Data Models
-   **PingResult Interface**:
    -   Location: `src/app/models/ping-result.interface.ts`
    -   Fields: `timestamp: Date`, `latencyMs: number | null`, `status: 'ok' | 'error'`
    -   [Source: `docs/rescrita-tecnica-angular.md#31-estrutura-de-pastas-padrão-angular-cli`]

### API Specifications
-   **Ping Mechanism**:
    -   Method: HTTP `HEAD` request (or `GET` with `observe: 'response'`).
    -   Target: Configurable URL (default to `https://www.google.com` or similar reliable target).
    -   Calculation: `Latência = (Tempo Resposta - Tempo Início)`.
    -   [Source: `docs/rescrita-tecnica-angular.md#41-o-problema-do-ping-solução-cross-platform`]

### Project Structure & File Locations
-   **Service**: `src/app/services/monitor.service.ts`
-   **Model**: `src/app/models/ping-result.interface.ts`
-   **Tests**: `src/app/services/monitor.service.spec.ts`

### Technical Constraints
-   **Standalone Components**: The app uses Standalone Components. Ensure `HttpClient` is provided correctly in `src/main.ts` (using `provideHttpClient()`), as `app.module.ts` might not be the primary configuration point or might need refactoring if the scaffolding created an NgModule-based app (Ionic defaults vary). *Note: Check `src/main.ts` and `src/app/app.module.ts` to see which bootstrapping method is used.*
-   **Android Compatibility**: Logic must rely PURELY on Web APIs (`HttpClient`). NO Node.js APIs (`child_process`, `dgram`) allowed. [Source: `docs/rescrita-tecnica-angular.md#7-critérios-de-aceite-dor`]

### Testing
-   **Frameworks**: Jasmine & Karma (Standard Angular stack).
-   **Mocking**: Use `HttpTestingController` from `@angular/common/http/testing` to mock network requests.
-   **Coverage**: Ensure tests cover success (200 OK) and failure (timeout/error) scenarios.

## Tasks / Subtasks
- [x] Application Configuration (AC: 1)
    - [x] Verify `src/main.ts` or `src/app/app.module.ts` configuration.
    - [x] Add `provideHttpClient()` to the application providers (in `main.ts` for standalone or `imports` for NgModule).
- [x] Define Data Model (AC: 2)
    - [x] Create directory `src/app/models`.
    - [x] Create `src/app/models/ping-result.interface.ts`.
    - [x] Define interface `PingResult`.
- [x] Create Monitor Service (AC: 1)
    - [x] Run `ionic g service services/monitor`.
    - [x] Verify `MonitorService` is created in `src/app/services/`.
- [x] Implement Service Logic (AC: 3, 4, 5, 6)
    - [x] Import `HttpClient`.
    - [x] Define `private pingResults$ = new BehaviorSubject<PingResult[]>([]);`.
    - [x] Implement `measureLatency(url: string): Observable<PingResult>`.
        -   Capture start time.
        -   Make HTTP HEAD request.
        -   Calculate duration on success.
        -   Return `PingResult` with status 'ok'.
        -   Catch error, return `PingResult` with status 'error' and latency `null`.
    - [x] Implement `startMonitoring(url: string, intervalMs: number)`.
        -   Use `timer(0, intervalMs)` to trigger `measureLatency`.
        -   Subscribe and push results to `pingResults$`.
        -   Maintain only last 50 results in the array.
    - [x] Implement `stopMonitoring()`.
        -   Unsubscribe from the timer subscription.
    - [x] Expose `get results$()` as `Observable<PingResult[]>`.
- [x] Unit Testing (AC: 7)
    - [x] Update `src/app/services/monitor.service.spec.ts`.
    - [x] Mock `HttpClient` using `HttpTestingController`.
    - [x] Test `measureLatency` success case (latency calculation).
    - [x] Test `measureLatency` error case (packet loss).
    - [x] Test `startMonitoring` updates the subject.

## Dev Agent Record
### File List
- netmonitor/src/app/app.module.ts
- netmonitor/src/app/models/ping-result.interface.ts
- netmonitor/src/app/services/monitor.service.ts
- netmonitor/src/app/services/monitor.service.spec.ts
- netmonitor/tsconfig.json

## Project Structure Notes
-   The architectural requirement specifies `src/app/models` and `src/app/services`, which aligns with the standard Angular structure.
-   The previous story noted strict mode is enabled, so strict typing in the interface is required.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-03 | 1.0 | Initial Approval and Validation Fixes | PO (Sarah) |

## QA Results

### Review Date: 2025-12-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
The implementation is high quality, adhering strictly to the "Boring Stack" philosophy. The use of `HttpClient` with `head` requests ensures cross-platform compatibility. `BehaviorSubject` and RxJS `timer` are used correctly for state management and polling, with proper cleanup.

### Refactoring Performed
None. The submitted code met all quality standards.

### Compliance Check
- Coding Standards: [✓] Clean, strict typing, proper Angular usage.
- Project Structure: [✓] Follows defined structure.
- Testing Strategy: [✓] Unit tests cover success and failure scenarios.
- All ACs Met: [✓] All 7 ACs verified.

### Improvements Checklist
- [x] Verified clean unsubscribe logic in `stopMonitoring`.
- [x] Confirmed strict typing in `PingResult`.
- [ ] (Future) Extract ping URL to configuration.

### Security Review
No specific security risks identified. Usage of standard `HttpClient` is secure.

### Performance Considerations
Memory usage is bounded (50 items). Polling interval is controlled by consumer.

### Files Modified During Review
None.

### Gate Status
Gate: PASS → docs/qa/gates/1.2.core-monitoring-service-implementation.yml

### Recommended Status
[✓ Ready for Done]
