# Story 2.1: CSS Variable Refactoring

## Status
Done

## Story
**As a** Developer,
**I want** to refactor existing hardcoded colors into CSS variables AND implement the theme toggle,
**so that** I can easily invert the color scheme for Light Mode and the user can switch between them.

## Acceptance Criteria
1. All structural colors (backgrounds, text, borders) use CSS variables.
2. A `light-theme` (or default) and `dark-theme` class structure is defined in `global.scss`.
3. The application looks identical to the current version when the Dark theme is active.
4. A toggle button allows the user to switch between Light and Dark modes.
5. The theme selection is persisted (e.g., localStorage).
6. Light Mode chart colors are visually appealing (blue/vibrant) and not "ugly grey".

## Tasks / Subtasks
- [x] Refactor `global.scss` for Theme Support (AC: 2)
- [x] Refactor Chart Colors in `HomePage` (AC: 1, 3)
- [x] Verify Dark Mode Persistence (AC: 3)
- [x] Implement Theme Toggle Button (AC: 4)
    - [x] Add icon button to HomePage header.
    - [x] Implement toggle logic in TS.
- [x] Persist Theme Selection (AC: 5)
    - [x] Save/Load from localStorage.
- [x] Polish Light Mode Colors (AC: 6)
    - [x] Update variables.scss with better light mode chart colors.
    - [x] Ensure chart updates dynamically on theme switch.

## Dev Notes
**Context:**
This is the first story of Epic 2 (Theme System). Currently, the app is hardcoded to "Always Dark" via Ionic's CSS import. We need to decouple this to allow dynamic switching.

**File Locations:**
- **Global Styles:** `netmonitor/src/global.scss` [Source: Architecture Scan]
- **Theme Variables:** `netmonitor/src/theme/variables.scss` [Source: Architecture Scan]
- **Home Logic:** `netmonitor/src/app/home/home.page.ts` [Source: Architecture Scan]

**Technical Details:**
- **Ionic Dark Mode:** We are moving from `dark.always.css` to `dark.class.css`. This requires the `ion-palette-dark` class to be applied to the `body` (or `html`) to trigger dark mode.
- **Chart.js Colors:** The hardcoded color `rgba(148,159,177,1)` corresponds to a specific grey-blue. This should probably be the `--ion-color-medium` or a specific chart color variable.
- **Variable Strategy:**
    - Define `--chart-line-color` and `--chart-fill-color` in `variables.scss`.
    - In `home.page.ts`, read these variables. If necessary, create a helper to read computed styles when the theme changes (though dynamic chart updating might be Story 2.2, for now just ensuring the *structure* is there is key. But wait, if we refactor to variables, the chart needs to pick them up. Story 2.2 is "Theme Toggle". This story 2.1 is "CSS Variable Refactoring". So static refactoring is the goal, but it must work).

**Project Structure Alignment:**
- No new files expected, just modification of existing style and logic files.

**Testing Requirements:**
- **Visual Verification:** Manually verify that with the dark class applied, the app looks exactly as it did before.
- **Light Mode Check:** Verify that *without* the dark class, the app renders in a default Light mode (even if unpolished, it shouldn't be broken).

## Dev Agent Record

### File List
- netmonitor/src/global.scss
- netmonitor/src/theme/variables.scss
- netmonitor/src/app/home/home.page.ts

### Completion Notes
- Refactored global styles to use class-based dark mode.
- Defined light and dark theme variables in variables.scss.
- Updated HomePage chart configuration to use CSS variables for colors.
- Implemented Theme Toggle button in HomePage.
- Implemented theme persistence using localStorage.
- Fixed chart colors in Light Mode (used Ionic Primary Blue).
- Fixed visibility of statistic numbers in Dark Mode (added explicit white/grey variables).
- Verified build passes.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-12-06 | 1.0.0 | Initial Draft | Bob (Scrum Master) |

## QA Results

### Review Date: 2025-12-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation correctly refactors hardcoded colors into CSS variables, enabling theme switching. The structure follows Ionic best practices.

### Refactoring Performed

- **File**: `netmonitor/src/app/home/home.page.ts`
  - **Change**: Changed `getComputedStyle(document.documentElement)` to `getComputedStyle(document.body)`.
  - **Why**: To ensure CSS variables defined under class selectors (like `.ion-palette-dark`) applied to the body are correctly resolved.
  - **How**: Updated the target element in the `updateChartTheme` method.

- **File**: `netmonitor/src/theme/variables.scss`
  - **Change**: Added explicit chart variables to `.ion-palette-dark` block.
  - **Why**: To provide a clear override point for dark mode chart colors and ensure consistency if the root values change.
  - **How**: Copied the variable definitions into the dark mode selector.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] (Unit tests pass; Visual check required manually)
- All ACs Met: [✓]

### Improvements Checklist

- [x] Refactored `home.page.ts` to read styles from `body`.
- [x] Explicitly defined chart variables in dark theme in `variables.scss`.
- [ ] Future: Add visual regression testing (e.g., with Playwright or Cypress) to automate AC 3.

### Security Review

No security concerns found.

### Performance Considerations

CSS variables are performant. Chart update logic runs only on init and data changes.

### Files Modified During Review

- `netmonitor/src/app/home/home.page.ts`
- `netmonitor/src/theme/variables.scss`
- (Please update File List)

### Gate Status

Gate: PASS → docs/qa/gates/2.1.css-variable-refactoring.yml
Risk profile: docs/qa/assessments/2.1.css-variable-refactoring-risk-20251206.md
NFR assessment: docs/qa/assessments/2.1.css-variable-refactoring-nfr-20251206.md

### Recommended Status

[✓ Ready for Done]

