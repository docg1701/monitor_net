# Story 2.2: Theme Toggle & Persistence

## Status
Done

## Story
**As a** User,
**I want** the application to respect my system's theme preference by default and allow me to override it,
**so that** I can customize the viewing experience or have it match my environment automatically.

## Acceptance Criteria
1. **System Preference Fallback**: On app launch, if no user preference is saved, the application defaults to the OS/System theme (Light or Dark).
2. **System Preference Listener**: If the user has *not* explicitly set a preference, the app updates automatically when the OS theme changes.
3. **Manual Override**: The existing toggle button allows the user to explicitly switch themes (Light/Dark).
4. **Persistence**: The manual selection is saved to `localStorage` and respected on next launch (overriding OS preference).
5. **Visual Consistency**: Chart colors and UI elements remain legible and consistent during all automatic or manual switches.

## Tasks / Subtasks
- [x] Implement System Preference Detection (AC: 1)
    - [x] Update `ngOnInit` in `home.page.ts` to check `window.matchMedia('(prefers-color-scheme: dark)')` when no local storage value exists.
- [x] Implement System Preference Listener (AC: 2)
    - [x] Add a listener to the media query to update the theme dynamically if `localStorage` is empty.
- [x] Verify/Refine Persistence Logic (AC: 3, 4)
    - [x] Ensure `toggleTheme` sets the preference.
    - [x] Consider adding a "Reset to System" option (Optional, but good for "un-setting" preference. For now, just ensuring fallback works if storage is cleared is enough, or maybe the toggle loops? No, simple toggle is fine. Just ensure the *initial* load handles the "null" case correctly).
- [x] Verify Chart Updates (AC: 5)
    - [x] Ensure `updateChartTheme` is called when system theme changes (if following system).

## Dev Notes
**Context:**
Story 2.1 implemented the basic toggle and persistence, but it defaults to Light mode if no preference is found, ignoring the OS setting. This story completes the feature by adding OS awareness.

**File Locations:**
- **Home Logic:** `netmonitor/src/app/home/home.page.ts` [Source: Story 2.1 Record]

**Technical Details:**
- **Media Query:** Use `window.matchMedia('(prefers-color-scheme: dark)')`.
- **Logic Flow:**
    1. Check `localStorage`.
    2. If value exists -> Use it.
    3. If NO value -> Use `mediaQuery.matches`.
    4. Store `mediaQuery` listener to handle runtime system changes (only if no local preference is set).
- **Chart Updates:** The `updateChartTheme` method relies on computed styles. Ensure it runs after the class list is updated.
- **Performance:** Ensure that `updateChartTheme` and any subsequent `chart.update()` calls are handled efficiently to avoid UI stutter during theme switches, especially if triggered by rapid system preference changes (though rare).

**Project Structure Alignment:**
- Modifying existing file `netmonitor/src/app/home/home.page.ts`.

**Testing Requirements:**
- **Unit Tests:** Mock `window.matchMedia` in `home.page.spec.ts` to verify logic.
- **Manual Verification:**
    1. Clear Local Storage.
    2. Set OS to Dark -> App should be Dark.
    3. Set OS to Light -> App should be Light.
    4. Toggle switch -> App changes and saves preference.
    5. Reload -> Saved preference persists, ignoring OS.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-12-06 | 1.0 | Initial Draft | PO |
| 2025-12-06 | 1.1 | Added performance note and Approved | PO |

## Dev Agent Record
### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
None

### Completion Notes List
- Refactored `home.page.ts` to include `initializeTheme` logic with `window.matchMedia`.
- Added listener for `prefers-color-scheme` changes, active only when `localStorage` is empty.
- Updated `toggleTheme` to ensure persistence and UI updates.
- Refactored `home.page.spec.ts` to mock `matchMedia` and added comprehensive tests for theme logic.
- Verified all acceptance criteria with unit tests.

### File List
- `netmonitor/src/app/home/home.page.ts`
- `netmonitor/src/app/home/home.page.spec.ts`

## QA Results
_TBD_

### Review Date: 2025-12-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is solid and meets all acceptance criteria. The use of `matchMedia` and `localStorage` is correct. The chart theme update logic is clever but relies on computed styles, which is acceptable for this scope.

During the review, I identified that `MonitorService` was not properly testable because it directly imported `invoke` from Tauri. This caused unrelated test failures. I refactored it to use a facade (`TauriService`) and fixed the tests.

### Refactoring Performed

- **File**: `netmonitor/src/app/services/tauri.service.ts`
  - **Change**: Created a wrapper service for Tauri's `invoke`.
  - **Why**: To allow mocking of Tauri calls in unit tests.
  - **How**: Simple injectable class wrapping the static function.

- **File**: `netmonitor/src/app/services/monitor.service.ts`
  - **Change**: Injected `TauriService` instead of direct import.
  - **Why**: Dependency Injection enables testing.
  - **How**: Updated constructor/inject and usage.

- **File**: `netmonitor/src/app/services/monitor.service.spec.ts`
  - **Change**: Rewrote tests to mock `TauriService`.
  - **Why**: Previous tests were using `HttpTestingController` (outdated) and failing.
  - **How**: Used `jasmine.createSpyObj`.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Improvements Checklist

- [x] Refactored MonitorService for testability
- [x] Fixed broken MonitorService tests

### Security Review

No security implications found. Theme preference is non-sensitive data.

### Performance Considerations

Theme switching triggers a layout recalculation and chart update. Logic ensures this happens efficiently.

### Files Modified During Review

- `netmonitor/src/app/services/tauri.service.ts` (Created)
- `netmonitor/src/app/services/monitor.service.ts`
- `netmonitor/src/app/services/monitor.service.spec.ts`

### Gate Status

Gate: PASS → docs/qa/gates/2.2.theme-toggle-and-persistence.yml

### Recommended Status

[✓ Ready for Done]

